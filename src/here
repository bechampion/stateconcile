from winrm.protocol import Protocol
import sys
import json
SERVICE="w32time"
TIMEOUT=3
status={}
while True:
    for s in range(1,5):
        endpoint='adapter-%s.spoke-scoreboard-dev.hub.internal' % str(s) 
        if endpoint not in status.keys():
            status[endpoint] = {}
        try:
            p = Protocol(
                endpoint='https://adapter-%s.spoke-scoreboard-dev.hub.internal:5986/wsman' %str(s),
                transport='basic',
                username=r'jgarcia',
                password="Qwe123!!",
                read_timeout_sec = TIMEOUT + 3,
                operation_timeout_sec = TIMEOUT,
                server_cert_validation='ignore')
            shell_id = p.open_shell()
            command_id = p.run_command(shell_id, 'powershell -command "Get-Service -name w32time | ConvertTo-json"')
            std_out, std_err, status_code = p.get_command_output(shell_id, command_id)
            out=json.loads(std_out.decode())
            print(std_err.decode())
            status[str(endpoint)]= { "ServiceName" : out["ServiceName"] , "Status" : out["Status"]}
            print(json.dumps(status,sort_keys=True , indent=4))
            p.cleanup_command(shell_id, command_id)
            p.close_shell(shell_id)
        except:
            e_error=str(sys.exc_info())
            status[str(endpoint)]= { "ServiceName" : out["ServiceName"] , "Status" : e_error}
